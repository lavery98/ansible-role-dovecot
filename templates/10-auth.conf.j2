{{ ansible_managed | comment }}

sql_driver = mysql

mysql {{ dovecot_mysql_host }} {
  user = {{ dovecot_mysql_user }}
  password = {{ dovecot_mysql_password }}
  dbname = {{ dovecot_mysql_database }}
}

passdb sql {
  default_password_scheme = SHA512-CRYPT

  query = SELECT username AS user, password \
    FROM mailbox \
    WHERE username = '%{user}' AND active = '1'
}

userdb sql {
  query = SELECT CONCAT('/var/vmail', maildir) AS home \
    FROM mailbox \
    WHERE username = '%{user}' AND active = '1'
  # For using doveadm -A:
  iterate_query = SELECT username FROM mailbox
}

# https://doc.dovecot.org/main/howto/sasl/postfix.html
service auth {
  unix_listener /var/spool/postfix/private/auth {
    group = postfix
    mode = 0600
    user = postfix
  }
}
